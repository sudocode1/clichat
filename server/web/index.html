<link rel="stylesheet" href="./styles.css">

<body id="cl">
    <h1 id="title">test</h1>
</body>


<script>
    let parameters = window.location.search.replace(`?`, ``).split("&");
    let param = {};
    let id;

    parameters.map(x => {
        let spl=x.split("=");
        param[spl[0]] = spl[1]; 
    });

    console.log(param);

    if (param["username"]) {
        console.log("authorize");
        let ws = new WebSocket('ws://YOUR_SERVER_IP');

        let messageHistory = [];

        document.getElementById('cl').innerHTML = `<h1>CLIChat Web Client (v1) for ${window.location.hostname}</h1>\n<div id="msgbox"></div>\n<textarea id="chatbox"></textarea><button id="sendButton">send</button><button id="clearChatBox">clear box</button>`;


        function historyPush(push) {
            messageHistory.push(push);
            let string = "<h2>";

            messageHistory.map(x => {
                string += `[${x[2]}] ${x[0]}${x[3] ? ":" : ""} ${x[1]}<br>`;
            });

            string += "</h2>";
            document.getElementById('msgbox').innerHTML = string;
        }

        function historyClear() {
            messageHistory = [];
            historyPush(["Chat", "Cleared", new Date().toLocaleString(), false])
        }

        let handlers = {
            message: (username, content) => {
                historyPush([username, content, new Date().toLocaleString(), true]);
            },

            disconnect: username => {
                historyPush([username, "left the room", new Date().toLocaleString(), false]);
            },

            join: username => {
                historyPush([username, "joined the room", new Date().toLocaleString(), false]);
            },

            id: (x, serverVer) => {
                id = x;
                historyPush(["You", `joined the room | Server Version ${serverVer}`, new Date().toLocaleString(), false]);
            }, 

            refusal: msg => {
                historyPush(["REFUSAL", msg, true]);
            }
        }

        ws.onopen = async () => {
            ws.send(JSON.stringify(['auth', { ip: "0.0.0.0", username: param["username"] }]));
        }

        ws.onmessage = s => {
            const d = JSON.parse(s.data);
            handlers[d[0]] && handlers[d[0]](...d.slice(1));
        };

        // setInterval(() => {
        //     if(document.getElementById('chatbox').value.endsWith('\n')) {
        //         ws.send(['msg', { username: param["username"], content: msgbox.value  }]);
        //         msgbox.value = "";
        //     }
        // }, 10);

        
        sendButton.onclick = () => {
            ws.send(JSON.stringify(['msg', { id, msg: chatbox.value + "\n" }]));
            historyPush([param['username'], chatbox.value, new Date().toLocaleString(), true ])
            chatbox.value = "";
        }

        clearChatBox.onclick = () => {
            historyClear();
        }

    } else {

    }
</script>